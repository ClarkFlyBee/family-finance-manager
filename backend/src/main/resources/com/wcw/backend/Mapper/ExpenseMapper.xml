<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wcw.backend.Mapper.ExpenseMapper">

    <!-- 结果映射 -->
    <resultMap id="ExpenseResultMap" type="com.wcw.backend.Entity.Expense">
        <id property="id" column="id"/>
        <result property="expNo" column="exp_no"/>
        <result property="ownerType" column="owner_type"/>
        <result property="ownerId" column="owner_id"/>
        <result property="categoryId" column="category_id"/>
        <result property="amount" column="amount"/>
        <result property="expTime" column="exp_time"/>
        <result property="remark" column="remark"/>
        <result property="isDraft" column="is_draft"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <resultMap id="ExpenseVOResultMap" type="com.wcw.backend.VO.ExpenseVO">
        <result property="id" column="id"/>
        <result property="expNo" column="exp_no"/>
        <result property="ownerType" column="owner_type"/>
        <result property="ownerName" column="owner_name"/>
        <result property="categoryName" column="category_name"/>
        <result property="categoryId" column="category_id"/>
        <result property="amount" column="amount"/>
        <result property="expTime" column="exp_time"/>
        <result property="remark" column="remark"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 新增 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO expense (
            exp_no, owner_type, owner_id, category_id,
            amount, exp_time, remark, is_draft,
            created_at, updated_at
        ) VALUES (
                     #{expNo}, #{ownerType}, #{ownerId}, #{categoryId},
                     #{amount}, #{expTime}, #{remark}, #{isDraft},
                     NOW(), NOW()
                 )
    </insert>

    <!-- 根据 ID 查询 -->
    <select id="selectById" resultMap="ExpenseResultMap">
        SELECT *
        FROM expense
        WHERE id = #{id}
    </select>

    <!-- 查询总数（用于分页） -->
    <select id="selectExpenseCount" resultType="long">
        SELECT COUNT(*)
        FROM expense e
        LEFT JOIN category c ON e.category_id = c.id
        LEFT JOIN user u ON e.owner_type = 'M' AND e.owner_id = u.id
        LEFT JOIN family f ON e.owner_type = 'F' AND e.owner_id = f.id
        WHERE 1=1
          <if test="query != null">
              <if test="query.ownerType != null">
                  AND e.owner_type = #{query.ownerType}
              </if>
              <if test="query.ownerId != null">
                  AND e.owner_id = #{query.ownerId}
              </if>
              <if test="query.categoryId != null">
                  AND e.category_id = #{query.categoryId}
              </if>
              <if test="query.startTime != null">
                  AND e.inc_time >= #{query.startTime}
              </if>
              <if test="query.endTime != null">
                  AND e.inc_time &lt;= #{query.endTime}
              </if>
              <if test="query.keyword != null and query.keyword != ''">
                  AND e.remark LIKE CONCAT('%', #{query.keyword}, '%')
              </if>
          </if>
    </select>

    <!-- 分页查询 VO -->
    <select id="selectExpensePage" resultMap="ExpenseVOResultMap">
        SELECT
        e.id,
        e.exp_no,
        e.owner_type,
        e.owner_id,
        c.id AS category_id,
        c.name AS category_name,
        e.amount,
        e.exp_time,
        e.remark,
        e.created_at
        FROM expense e
        LEFT JOIN category c ON e.category_id = c.id
        WHERE 1=1
        <if test="query != null">
            <if test="query.ownerType != null">
                AND e.owner_type = #{query.ownerType}
            </if>
            <if test="query.ownerId != null">
                AND e.owner_id = #{query.ownerId}
            </if>
            <if test="query.categoryId != null">
                AND e.category_id = #{query.categoryId}
            </if>
            <if test="query.startTime != null">
                AND e.inc_time >= #{query.startTime}
            </if>
            <if test="query.endTime != null">
                AND e.inc_time &lt;= #{query.endTime}
            </if>
            <if test="query.keyword != null and query.keyword != ''">
                AND e.remark LIKE CONCAT('%', #{query.keyword}, '%')
            </if>
        </if>
        ORDER BY e.exp_time DESC
        LIMIT #{offset}, #{size}
    </select>

    <!-- 更新 -->
    <update id="update">
        UPDATE expense SET
                          owner_type = #{ownerType},
                          owner_id = #{ownerId},
                          category_id = #{categoryId},
                          amount = #{amount},
                          exp_time = #{expTime},
                          remark = #{remark},
                          is_draft = #{isDraft},
                          updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- 删除 -->
    <delete id="deleteById">
        DELETE FROM expense WHERE id = #{id}
    </delete>

</mapper>